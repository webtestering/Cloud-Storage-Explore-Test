<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Storage Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px 16px;
        }
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="container p-6 md:p-12">
        <header class="header">
            <h1 class="text-4xl font-extrabold text-blue-400 mb-4 md:mb-0">Cloud Storage Explorer</h1>
            <div class="flex space-x-4">
                <button id="create-folder-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out cursor-pointer text-lg">
                    Create Folder
                </button>
                <label class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out cursor-pointer text-lg">
                    Upload File
                    <input type="file" id="file-upload-input" class="hidden">
                </label>
            </div>
        </header>

        <main>
            <div id="user-id-display" class="text-gray-400 text-sm mb-4 hidden">
                Authenticated User ID: <span id="user-id-text" class="font-mono text-gray-200 break-all"></span>
            </div>
            
            <div id="path-container" class="bg-gray-800 p-4 rounded-t-2xl shadow-xl">
                <button id="go-back-btn" class="text-blue-400 hover:underline mb-4 flex items-center hidden">
                    <span class="text-xl mr-2">‚¨ÜÔ∏è</span> Back
                </button>
                <p class="text-gray-400 text-sm">
                    Current Path: <span id="current-path-text" class="font-mono text-gray-200">/</span>
                </p>
            </div>

            <div id="file-list-container" class="bg-gray-800 p-6 rounded-b-2xl shadow-xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-200">Current Items (<span id="item-count">0</span>)</h2>
                <ul id="file-list" class="divide-y divide-gray-700"></ul>
            </div>
            
            <div id="empty-state" class="text-center py-20 bg-gray-700 rounded-b-2xl text-gray-500 hidden">
              <p class="text-2xl font-semibold mb-2">No items here!</p>
              <p class="text-lg">Upload a file or create a new folder.</p>
            </div>
        </main>
    </div>
    
    <!-- Modal for creating folder -->
    <div id="folder-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-white">Create New Folder</h3>
            <input 
                type="text"
                id="folder-name-input"
                class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Folder name"
            />
            <div class="flex justify-end space-x-2">
                <button id="cancel-folder-btn" class="px-4 py-2 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition">
                    Cancel
                </button>
                <button id="create-folder-submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition" disabled>
                    Create
                </button>
            </div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-900 flex items-center justify-center p-4">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // In-memory storage for file content
        const fileContentCache = new Map();
        
        let currentPath = '';
        let userId = null;
        let summaries = {};
        const summaryLoading = {};
        let items = []; // Global variable to store the list of items

        const elements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            userIdDisplay: document.getElementById('user-id-display'),
            userIdText: document.getElementById('user-id-text'),
            goBackBtn: document.getElementById('go-back-btn'),
            currentPathText: document.getElementById('current-path-text'),
            itemCount: document.getElementById('item-count'),
            fileList: document.getElementById('file-list'),
            emptyState: document.getElementById('empty-state'),
            fileUploadInput: document.getElementById('file-upload-input'),
            createFolderBtn: document.getElementById('create-folder-btn'),
            folderModal: document.getElementById('folder-modal'),
            folderNameInput: document.getElementById('folder-name-input'),
            cancelFolderBtn: document.getElementById('cancel-folder-btn'),
            createFolderSubmitBtn: document.getElementById('create-folder-submit-btn'),
        };

        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const getFileIcon = (item) => {
            if (item.isFolder) {
                return 'üìÇ';
            }
            const fileType = item.type;
            if (fileType.startsWith('image/')) {
                return 'üñºÔ∏è';
            } else if (fileType.startsWith('video/')) {
                return 'üìπ';
            } else if (fileType.startsWith('audio/')) {
                return 'üéß';
            } else if (fileType === 'application/pdf') {
                return 'üìÑ';
            } else if (fileType.startsWith('text/')) {
                return 'üìù';
            } else if (fileType.includes('zip') || fileType.includes('rar')) {
                return 'üì¶';
            }
            return 'üìÅ';
        };

        const updateFileList = (items) => {
            elements.fileList.innerHTML = '';
            if (items.length === 0) {
                elements.fileList.classList.add('hidden');
                elements.emptyState.classList.remove('hidden');
            } else {
                elements.fileList.classList.remove('hidden');
                elements.emptyState.classList.add('hidden');
                items.forEach((item) => {
                    const listItem = document.createElement('li');
                    listItem.className = "flex flex-col md:flex-row justify-between items-start md:items-center py-4 transition duration-200 ease-in-out hover:bg-gray-700 rounded-lg px-2";
                    
                    let summaryHtml = summaries[item.id] ? `<p class="mt-2 text-sm text-gray-300 italic">${summaries[item.id]}</p>` : '';
                    let summaryBtnHtml = '';
                    if (!item.isFolder) {
                        summaryBtnHtml = `<button class="generate-summary-btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" data-id="${item.id}" data-name="${item.name}" data-type="${item.type}" ${summaryLoading[item.id] ? 'disabled' : ''}>
                                            ${summaryLoading[item.id] ? 
                                              `<svg class="animate-spin h-4 w-4 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                              </svg>` : 
                                              '‚ú® Summary'
                                            }
                                        </button>`;
                    }
                    
                    const downloadBtnHtml = item.isFolder ? '' : `<button class="download-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-300 ease-in-out" data-name="${item.name}">Download</button>`;

                    const deleteBtnHtml = `<button class="delete-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-full text-sm shadow-md transition duration-300 ease-in-out" data-id="${item.id}" data-isfolder="${item.isFolder}">Delete</button>`;

                    listItem.innerHTML = `
                        <div class="flex items-center space-x-4 mb-2 md:mb-0 w-full md:w-auto">
                            <span class="text-3xl">${getFileIcon(item)}</span>
                            <div class="flex-grow">
                                <button class="file-item-name text-left ${item.isFolder ? 'cursor-pointer' : ''}" data-name="${item.name}" data-isfolder="${item.isFolder}">
                                    <p class="text-lg font-medium ${item.isFolder ? 'text-blue-400 hover:underline' : 'text-gray-100'}">${item.name}</p>
                                </button>
                                ${!item.isFolder ? `<p class="text-sm text-gray-400">${formatFileSize(item.size)}</p>` : ''}
                                ${summaryHtml}
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-4 md:mt-0 flex-shrink-0">
                            ${summaryBtnHtml}
                            ${downloadBtnHtml}
                            ${deleteBtnHtml}
                        </div>
                    `;
                    elements.fileList.appendChild(listItem);
                });
            }
            elements.itemCount.textContent = items.length;
        };

        const handleGenerateSummary = async (item) => {
            summaryLoading[item.id] = true;
            summaries = { ...summaries, [item.id]: 'Generating summary...' };
            updateFileList(items); // Re-render to show loading state

            const prompt = `Generate a one-sentence, concise, descriptive summary for a file with the following name and type: "${item.name}" and "${item.type}". Focus on what the file might contain.`;
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let summaryText = 'Failed to generate summary.';
            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        retries++;
                        await new Promise(res => setTimeout(res, initialDelay * Math.pow(2, retries)));
                        continue;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        summaryText = result.candidates[0].content.parts[0].text;
                    }
                    break;
                } catch (e) {
                    console.error("API call failed: ", e);
                    retries++;
                    await new Promise(res => setTimeout(res, initialDelay * Math.pow(2, retries)));
                }
            }
            
            summaries = { ...summaries, [item.id]: summaryText };
            summaryLoading[item.id] = false;
            updateFileList(items); // Re-render with new summary
        };

        const handleUpload = async (file) => {
            if (!userId) return console.error("User not authenticated.");
            if (!file) return;

            const fileData = {
                name: file.name,
                size: file.size,
                type: file.type,
                timestamp: serverTimestamp(),
                isFolder: false,
                path: currentPath,
            };

            fileContentCache.set(file.name, file);
            
            const collectionPath = `/artifacts/${appId}/users/${userId}/files`;
            try {
                await addDoc(collection(db, collectionPath), fileData);
                console.log("File metadata uploaded successfully.");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        const handleDelete = async (itemId) => {
            if (!userId) return console.error("User not authenticated.");
            const collectionPath = `/artifacts/${appId}/users/${userId}/files`;
            try {
                await deleteDoc(doc(db, collectionPath, itemId));
                console.log("Item deleted successfully.");
                delete summaries[itemId];
                // The onSnapshot listener will handle the UI update
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };

        const handleDownload = (fileName) => {
            const file = fileContentCache.get(fileName);
            if (file) {
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                console.error("File not found in cache. Cannot download.");
            }
        };

        const handleCreateFolder = async () => {
            if (!userId) return console.error("User not authenticated.");
            const folderName = elements.folderNameInput.value.trim();
            if (!folderName) return;

            const folderData = {
                name: folderName,
                size: 0,
                type: 'folder',
                timestamp: serverTimestamp(),
                isFolder: true,
                path: currentPath,
            };
            
            const collectionPath = `/artifacts/${appId}/users/${userId}/files`;
            try {
                await addDoc(collection(db, collectionPath), folderData);
                elements.folderNameInput.value = '';
                elements.folderModal.classList.add('hidden');
                console.log("Folder created successfully.");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        const handleGoBack = () => {
            const pathParts = currentPath.split('/');
            pathParts.pop();
            currentPath = pathParts.join('/');
            elements.currentPathText.textContent = currentPath === '' ? '/' : currentPath;
            elements.goBackBtn.classList.toggle('hidden', currentPath === '');
        };

        const handleOpenFolder = (folderName) => {
            currentPath = currentPath === '' ? folderName : `${currentPath}/${folderName}`;
            elements.currentPathText.textContent = currentPath;
            elements.goBackBtn.classList.remove('hidden');
        };

        // Event listeners
        elements.fileUploadInput.addEventListener('change', (e) => handleUpload(e.target.files[0]));
        elements.createFolderBtn.addEventListener('click', () => elements.folderModal.classList.remove('hidden'));
        elements.cancelFolderBtn.addEventListener('click', () => elements.folderModal.classList.add('hidden'));
        elements.createFolderSubmitBtn.addEventListener('click', handleCreateFolder);
        elements.folderNameInput.addEventListener('input', (e) => {
            elements.createFolderSubmitBtn.disabled = !e.target.value.trim();
        });
        elements.goBackBtn.addEventListener('click', handleGoBack);
        
        elements.fileList.addEventListener('click', (e) => {
            const target = e.target;
            const listItem = target.closest('li');
            if (!listItem) return;
            
            const deleteBtn = target.closest('.delete-btn');
            if (deleteBtn) {
                const itemId = deleteBtn.dataset.id;
                handleDelete(itemId);
                return;
            }

            const downloadBtn = target.closest('.download-btn');
            if (downloadBtn) {
                const fileName = downloadBtn.dataset.name;
                handleDownload(fileName);
                return;
            }

            const summaryBtn = target.closest('.generate-summary-btn');
            if (summaryBtn) {
                const id = summaryBtn.dataset.id;
                const name = summaryBtn.dataset.name;
                const type = summaryBtn.dataset.type;
                handleGenerateSummary({ id, name, type });
                return;
            }

            const fileItemName = target.closest('.file-item-name');
            if (fileItemName) {
                const isFolder = fileItemName.dataset.isfolder === 'true';
                if (isFolder) {
                    const folderName = fileItemName.dataset.name;
                    handleOpenFolder(folderName);
                }
            }
        });

        // Firebase Auth listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                elements.userIdText.textContent = userId;
                elements.userIdDisplay.classList.remove('hidden');
                
                const collectionPath = `/artifacts/${appId}/users/${userId}/files`;
                const q = query(collection(db, collectionPath), where('path', '==', currentPath));

                onSnapshot(q, (querySnapshot) => {
                    items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ ...doc.data(), id: doc.id });
                    });
                    updateFileList(items);
                }, (error) => {
                    console.error("Error fetching items: ", error);
                });

                elements.loadingSpinner.classList.add('hidden');

            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error signing in: ", error);
                }
            }
        });
        
    </script>
</body>
</html>
